# CAD图形显示优化
优化目标： CAD图形操作显示速度稳定
显示要素： 显示数据 + 渲染

## 显示数据
### 显示数据总量
显示数据总量 = 显示对象数量 x 单个对象的显示数据
**Sum = Number(数量) * Precision(精度， 对象的显示数据量只与精度有关)**
为了确保速度稳定，则显示数据总量需要保持稳定，也即Number和Precision成反比
* 生成确定范围的实体数据(数量如果太大，精度降低也无能为力)
* 数据精度根据像素密度确定(屏幕对应的范围大则精度低，反之精度高)
### 显示数据类型
显示数据主要有**线**和**面**
### 显示数据生成
#### 文字
文字分为形文字和TrueType字体两种。当文字显示的屏幕高度比较低时，
可以用矩形或线代替提高显示速度。
* 记录文字的高度向量和文字类型
* 形文字根据其范围生成一根线的退化数据
* TrueType文字生成两种退化数据，分别为1象素和5象素内的填充矩形(填充矩形不生成线)
#### 面
* 生成面时会附带着生成线，因为面在屏幕象素小于1时不显示，会导致缩小时某些地方空白
* 面的生成是通过原始顶点数据和索引的方式实现的
最终面的数据合并成两大类： 线和面，且是索引格式
#### 块
块是一类重用性比较高的对象，如果引用到的对象都生成一份显示数据则内存占用比较高。
故对块要单独生成显示数据，引用的对象引用其显示数据即可，但由于引用时存在矩阵变换的操作，
在显示时需要临时对其数据进行处理，会降低显示时的速度

## 渲染
渲染优化： 批处理 + 索引
### 批处理
由于GPU处理数据有一定的吞吐量，批处理能够尽可能的发挥GPU性能，提高图形渲染速度，批处理核心在于显示数据的合并
### 面
由于面包括线和面两种数据类型，在合并时需要参考前面合并的数据，如果之前是线，则先画线，反之则先画面，尽可能与前面数据融合
### 索引
* 共享顶点数据， 节约顶点数据的存储空间及顶点数据到GPU的拷贝
* 顶点数据减少会使顶点缓存用完的次数减少，减少因为缓存用完导致的GPU交互

## 开发
###  实体显示
实体在屏幕上显示长宽其中之一小于1时，先显示Trait数据设置颜色等(实体的第一个数据必须是属性数据)，然后用线代替实体显示
###  面生成
onSetVertexData时生成并添加到当前实体中， 然后紧跟索引画线或画面的方法，并这些输出最终合并成两类， 在显示时调用Render的Shell接口， 这个接口可以根据上一次的内容调整线和面的显示顺序， 顺序调整不影响Shell的显示效果.

由于面所占屏幕小于小于1时不显示，故在生成面时会同时生成线框数据(线数据不会被剔除显示)
### 文字
#### 生成
* 计算文字的高度向量
* 无论形文字或TrueType生成1象素的退化数据
* TrueType生成5象素对应的矩形退化数据，由于1象素数据已有，故生成矩形数据时不需要生成线框数据(提高显示数据生成速度和降低批处理合并的次数) 这个可以根据前面是线和面变化
#### 显示
* 高度小于1， 则采用线代替
* TrueType字体并且高度小于5, 则用填充矩形数据代替
### 合并
* 设置顶点后将输入input_设置为false, 表示当前设置顶点，但未输入图形
* 图解
 Last     Begin              End
  |--------------|-------------------|
     线              面               合并Last-Begin   线
     线              线    面         合并Last-End     线
     线              线    面    线   合并Begin-end    面    最后的线与下一个输入合并
   


## 待做
*  加载多线程
*  显示数据多线程
*  块显示数据
*  捕捉
*  Jig